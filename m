Return-Path: <linux-kernel+bounces-308963-lists+linux-kernel=lfdr.de@vger.kernel.org>
X-Original-To: lists+linux-kernel@lfdr.de
Delivered-To: lists+linux-kernel@lfdr.de
Received: from sv.mirrors.kernel.org (sv.mirrors.kernel.org [IPv6:2604:1380:45e3:2400::1])
	by mail.lfdr.de (Postfix) with ESMTPS id B05CB966459
	for <lists+linux-kernel@lfdr.de>; Fri, 30 Aug 2024 16:45:01 +0200 (CEST)
Received: from smtp.subspace.kernel.org (wormhole.subspace.kernel.org [52.25.139.140])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by sv.mirrors.kernel.org (Postfix) with ESMTPS id 694BF28314D
	for <lists+linux-kernel@lfdr.de>; Fri, 30 Aug 2024 14:45:00 +0000 (UTC)
Received: from localhost.localdomain (localhost.localdomain [127.0.0.1])
	by smtp.subspace.kernel.org (Postfix) with ESMTP id 29E381B1D7F;
	Fri, 30 Aug 2024 14:44:44 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=kernel.org header.i=@kernel.org header.b="b9Q+EPet"
Received: from smtp.kernel.org (aws-us-west-2-korg-mail-1.web.codeaurora.org [10.30.226.201])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 58DA018EFEE;
	Fri, 30 Aug 2024 14:44:42 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=10.30.226.201
ARC-Seal:i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1725029083; cv=none; b=aDO2eXfl6f+MXvmBYaZCJ+8MOvYiu0vJCcMOTjKYdfGboK9n8C1IbejdqrEe0oeGknWUN/nP1mgAdkak2xmCQvmHbdS05MtHp2CBapX5U/pgfwSGPsZjybxVmJDIlWhA4h1Tod69tLqVSAQlAZijXG2tV3R0vobOFZ3PDZ/vm3o=
ARC-Message-Signature:i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1725029083; c=relaxed/simple;
	bh=ztG9aO/UPReKf8rYuGZUvZxefpK4v5qH4ddRdTzZmr4=;
	h=Date:Message-ID:From:To:Cc:Subject:In-Reply-To:References:
	 MIME-Version:Content-Type; b=lAO13cg6D7lWBhsOVVohhn8sCfwRAVAQauYex4l6wkSVjvtHkXNsnIS3ZiM3F5pVgRq1p+1AB+pfRNGpLCQet48ZGjdATQkgEqlt8tG1OsvAKQJnSKJmxGQdhtsNczpzK0b1M5Q38Go6gbmCPbiSFr873vRe8rY9WpbrOmxgqJk=
ARC-Authentication-Results:i=1; smtp.subspace.kernel.org; dkim=pass (2048-bit key) header.d=kernel.org header.i=@kernel.org header.b=b9Q+EPet; arc=none smtp.client-ip=10.30.226.201
Received: by smtp.kernel.org (Postfix) with ESMTPSA id CE61CC4CEC2;
	Fri, 30 Aug 2024 14:44:42 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=kernel.org;
	s=k20201202; t=1725029082;
	bh=ztG9aO/UPReKf8rYuGZUvZxefpK4v5qH4ddRdTzZmr4=;
	h=Date:From:To:Cc:Subject:In-Reply-To:References:From;
	b=b9Q+EPetA1udPy1i03GtJtRiriTR2PXXX+wB9E+ZgwOIuMvVYAqcQZvYMoCRAMTAk
	 hjE32N4c33gt1+rgl8XnR7KSaPUxCOReJjXmPs9JFR33Kq7XKm4khcHI+569qTkWnb
	 a/dIy09EPpD4cB8l/GqbR9ba72bTN96useOrb3nP/GNjoD40uVRZP3rT9fGmD+n+pt
	 Qnoa82Ft0ssEtUNCezWZaFa0p1cDzWuIIbLeU7/uWWi0GdL3vcnz5dyzmnw4dw7l34
	 MnqLNrnriBpLMG6tZWqyOe1syj/u5C635lI2BsPgDqsWKzhFKeEdXZA1bhkWhlRFeA
	 dc6T6ZxQtbybg==
Received: from sofa.misterjones.org ([185.219.108.64] helo=goblin-girl.misterjones.org)
	by disco-boy.misterjones.org with esmtpsa  (TLS1.3) tls TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384
	(Exim 4.95)
	(envelope-from <maz@kernel.org>)
	id 1sk2rg-008GiT-8i;
	Fri, 30 Aug 2024 15:44:40 +0100
Date: Fri, 30 Aug 2024 15:44:39 +0100
Message-ID: <864j72vzmw.wl-maz@kernel.org>
From: Marc Zyngier <maz@kernel.org>
To: Sebastian Ene <sebastianene@google.com>
Cc: akpm@linux-foundation.org,
	alexghiti@rivosinc.com,
	ankita@nvidia.com,
	ardb@kernel.org,
	catalin.marinas@arm.com,
	christophe.leroy@csgroup.eu,
	james.morse@arm.com,
	vdonnefort@google.com,
	mark.rutland@arm.com,
	oliver.upton@linux.dev,
	rananta@google.com,
	ryan.roberts@arm.com,
	shahuang@redhat.com,
	suzuki.poulose@arm.com,
	will@kernel.org,
	yuzenghui@huawei.com,
	kvmarm@lists.linux.dev,
	linux-arm-kernel@lists.infradead.org,
	linux-kernel@vger.kernel.org,
	kernel-team@android.com
Subject: Re: [PATCH v9 0/5] arm64: ptdump: View the second stage page-tables
In-Reply-To: <20240827084549.45731-1-sebastianene@google.com>
References: <20240827084549.45731-1-sebastianene@google.com>
User-Agent: Wanderlust/2.15.9 (Almost Unreal) SEMI-EPG/1.14.7 (Harue)
 FLIM-LB/1.14.9 (=?UTF-8?B?R29qxY0=?=) APEL-LB/10.8 EasyPG/1.0.0 Emacs/29.4
 (aarch64-unknown-linux-gnu) MULE/6.0 (HANACHIRUSATO)
Precedence: bulk
X-Mailing-List: linux-kernel@vger.kernel.org
List-Id: <linux-kernel.vger.kernel.org>
List-Subscribe: <mailto:linux-kernel+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-kernel+unsubscribe@vger.kernel.org>
MIME-Version: 1.0 (generated by SEMI-EPG 1.14.7 - "Harue")
Content-Type: text/plain; charset=US-ASCII
X-SA-Exim-Connect-IP: 185.219.108.64
X-SA-Exim-Rcpt-To: sebastianene@google.com, akpm@linux-foundation.org, alexghiti@rivosinc.com, ankita@nvidia.com, ardb@kernel.org, catalin.marinas@arm.com, christophe.leroy@csgroup.eu, james.morse@arm.com, vdonnefort@google.com, mark.rutland@arm.com, oliver.upton@linux.dev, rananta@google.com, ryan.roberts@arm.com, shahuang@redhat.com, suzuki.poulose@arm.com, will@kernel.org, yuzenghui@huawei.com, kvmarm@lists.linux.dev, linux-arm-kernel@lists.infradead.org, linux-kernel@vger.kernel.org, kernel-team@android.com
X-SA-Exim-Mail-From: maz@kernel.org
X-SA-Exim-Scanned: No (on disco-boy.misterjones.org); SAEximRunCond expanded to false

Hi Seb,

On Tue, 27 Aug 2024 09:45:43 +0100,
Sebastian Ene <sebastianene@google.com> wrote:
> 
> Hi,
> 
> 
> This series extends the ptdump support to allow dumping the guest
> stage-2 pagetables. When CONFIG_PTDUMP_STAGE2_DEBUGFS is enabled, ptdump
> registers the new following files under debugfs:
> - /sys/debug/kvm/<guest_id>/stage2_page_tables
> - /sys/debug/kvm/<guest_id>/stage2_levels
> - /sys/debug/kvm/<guest_id>/ipa_range
> 
> This allows userspace tools (eg. cat) to dump the stage-2 pagetables by
> reading the 'stage2_page_tables' file.
> The output format has the following fields:
> <IPA range> <size> <level> <access permissions> <mem_attributes>
> 
> Below is the output of a guest stage-2 pagetable dump running under Qemu.
> After a VM is created, the following files are available:
> 
> # cat /sys/kernel/debug/kvm/256-4/stage2_levels 
> 4
> # cat /sys/kernel/debug/kvm/256-4/ipa_range 
> 44
> # cat /sys/kernel/debug/kvm/256-4/stage2_page_tables 
> ---[ Guest IPA ]---
> 0x0000000000000000-0x0000000001000000          16M 2
> 0x0000000001000000-0x0000000001020000         128K 3
> 0x0000000001020000-0x0000000001021000           4K 3   R W X AF    
> 0x0000000001021000-0x0000000001200000        1916K 3
> 0x0000000001200000-0x0000000040000000        1006M 2
> 0x0000000040000000-0x0000000080000000           1G 0
> 0x0000000080000000-0x0000000081200000          18M 2   R W   AF BLK
> 0x0000000081200000-0x0000000081a00000           8M 2   R W X AF BLK
> 0x0000000081a00000-0x0000000081c00000           2M 2   R W   AF BLK
> 0x0000000081c00000-0x0000000082200000           6M 2   R W X AF BLK
> 0x0000000082200000-0x0000000082400000           2M 2   R W   AF BLK
> 0x0000000082400000-0x0000000082800000           4M 2   R W X AF BLK
> 0x0000000082800000-0x0000000082a00000           2M 2   R W   AF BLK
> 0x0000000082a00000-0x0000000082c00000           2M 2
> 0x0000000082c00000-0x0000000083200000           6M 2   R W X AF BLK
> 0x0000000083200000-0x0000000083400000           2M 2
> 0x0000000083400000-0x0000000083a00000           6M 2   R W X AF BLK
> 0x0000000083a00000-0x000000008fe00000         196M 2
> 0x000000008fe00000-0x0000000090000000           2M 2   R W   AF BLK
> 0x0000000090000000-0x0000000099400000         148M 2
> 0x0000000099400000-0x0000000099600000           2M 2   R W X AF BLK
> 0x0000000099600000-0x000000009b600000          32M 2
> 0x000000009b600000-0x000000009be00000           8M 2   R W X AF BLK
> 0x000000009be00000-0x000000009c000000           2M 2   R W   AF BLK
> 0x000000009c000000-0x00000000c0000000         576M 2

I've been giving this a go on my test systems with 16k pages, and it
doesn't really work as advertised:

root@babette:/sys/kernel/debug/kvm# cat 2573-13/stage2_*
2
---[ Guest IPA ]---
0x0000000000000000-0x0000000008000000         128M 
0x0000000008000000-0x00000000090a0000       17024K 3
0x00000000090a0000-0x00000000090a4000          16K 3   R W X AF    
0x00000000090a4000-0x000000000a000000       15728K 3

Only 16kB mapped? This is a full Linux guest running the Debian
installer, and just the kernel is about 20MB (the VM has 4GB of RAM,
and is using QEMU as the VMM)

So clearly something isn't playing as expected. Also, this '128M'
without a level being displayed makes me wonder. It is probably the
QEMU flash, but then the rest of the addresses don't make much sense
(RAM on QEMU is at 1GB, not at 128MB.

On another system with kvmtool, I get something similar:

root@duodenum:/home/maz# cat /sys/kernel/debug/kvm/*/stage2_*
2
---[ Guest IPA ]---
0x0000000000000000-0x0000000001020000       16512K 3
0x0000000001020000-0x0000000001024000          16K 3   R W X AF    
0x0000000001024000-0x0000000002000000       16240K 3

and kvmtool places the RAM at 2GB. Clearly not what we're seeing here.

Could you please verify this?

Thanks,

	M.

-- 
Without deviation from the norm, progress is not possible.


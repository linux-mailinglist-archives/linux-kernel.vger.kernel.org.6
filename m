Return-Path: <linux-kernel+bounces-542575-lists+linux-kernel=lfdr.de@vger.kernel.org>
X-Original-To: lists+linux-kernel@lfdr.de
Delivered-To: lists+linux-kernel@lfdr.de
Received: from sy.mirrors.kernel.org (sy.mirrors.kernel.org [IPv6:2604:1380:40f1:3f00::1])
	by mail.lfdr.de (Postfix) with ESMTPS id 15EB3A4CB40
	for <lists+linux-kernel@lfdr.de>; Mon,  3 Mar 2025 19:50:13 +0100 (CET)
Received: from smtp.subspace.kernel.org (relay.kernel.org [52.25.139.140])
	(using TLSv1.2 with cipher ECDHE-ECDSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by sy.mirrors.kernel.org (Postfix) with ESMTPS id B8D227A93F3
	for <lists+linux-kernel@lfdr.de>; Mon,  3 Mar 2025 18:49:11 +0000 (UTC)
Received: from localhost.localdomain (localhost.localdomain [127.0.0.1])
	by smtp.subspace.kernel.org (Postfix) with ESMTP id 95B5B22DFB5;
	Mon,  3 Mar 2025 18:50:01 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=kernel.org header.i=@kernel.org header.b="ZOyoKEdb"
Received: from smtp.kernel.org (aws-us-west-2-korg-mail-1.web.codeaurora.org [10.30.226.201])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id DEC39215F7D;
	Mon,  3 Mar 2025 18:50:00 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=10.30.226.201
ARC-Seal:i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1741027801; cv=none; b=GRLX8Ir0fAIVpe6Wv6VHqQOG/G7B9uA+ook2F4xcD31gUqeAS0wqCKT72/iBkLJUjTJjaljpLEqbSkLrT6eFwJtHyipUNy1omz5Iw7DWOr/u+iCJWdGJ33KYltyb5apH16kJLECGe7KKp4grZcye+qVbdWQMfZ+S6Vjv+narw+A=
ARC-Message-Signature:i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1741027801; c=relaxed/simple;
	bh=ay2Mn2td7LnvXWZz0y/fV3J9yKVFlbL+Ii+8sPB9FlI=;
	h=Date:Message-ID:From:To:Cc:Subject:In-Reply-To:References:
	 MIME-Version:Content-Type; b=EXKRTzv/EVUpbl6gSCJLb3npttbZqlh+mSgQgtw7WhwOjdEWjUhvMpOKWAX6J+2iGhc8LwrTQ60S/hDmRxcg9i+a7z6JIy0XIx7boWB84fXbHZ6JpRMfpdacJqjU+hg9G2FSP/Psiedgybd0oKlqfyYt9sJMMzzaVAhohSZWop4=
ARC-Authentication-Results:i=1; smtp.subspace.kernel.org; dkim=pass (2048-bit key) header.d=kernel.org header.i=@kernel.org header.b=ZOyoKEdb; arc=none smtp.client-ip=10.30.226.201
Received: by smtp.kernel.org (Postfix) with ESMTPSA id AA80BC4CED6;
	Mon,  3 Mar 2025 18:50:00 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=kernel.org;
	s=k20201202; t=1741027800;
	bh=ay2Mn2td7LnvXWZz0y/fV3J9yKVFlbL+Ii+8sPB9FlI=;
	h=Date:From:To:Cc:Subject:In-Reply-To:References:From;
	b=ZOyoKEdboUWUG+YMMkdL5RPjsQQjxkQgZljsCmkfUknphh5NWjVd5xuL2U5V5YcPd
	 IycN7aSsNST2N/J6LErZhR1QBg+cSC2AxMlhHhMhlI5qge3YS08YlGALiMwSP4GGfx
	 koSc1w6VFEM/kLaIoZAfFlHxtHrKzuxX0wstpuhDgBxe0fzvghFQVz+sZINJH7RgKz
	 qqgvIF9/c79a16CFL7ks+slGk061OyzBAf2SapL7k3eydnwojqTphxYwrJKVV1hh75
	 d04bon1Z4dwQWtqHZz6+s8JAIvbP1zuwf8LjklHvnl4IZoTdDALzF0KYPiPVsHkhYy
	 noOLQ+bZpO1cg==
Received: from sofa.misterjones.org ([185.219.108.64] helo=goblin-girl.misterjones.org)
	by disco-boy.misterjones.org with esmtpsa  (TLS1.3) tls TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384
	(Exim 4.95)
	(envelope-from <maz@kernel.org>)
	id 1tpArW-009xKj-CA;
	Mon, 03 Mar 2025 18:49:58 +0000
Date: Mon, 03 Mar 2025 18:49:58 +0000
Message-ID: <86ikoqoso9.wl-maz@kernel.org>
From: Marc Zyngier <maz@kernel.org>
To: Peter Chen <peter.chen@cixtech.com>
Cc: robh@kernel.org,
	krzk+dt@kernel.org,
	conor+dt@kernel.org,
	catalin.marinas@arm.com,
	will@kernel.org,
	arnd@arndb.de,
	linux-arm-kernel@lists.infradead.org,
	devicetree@vger.kernel.org,
	linux-kernel@vger.kernel.org,
	cix-kernel-upstream@cixtech.com,
	marcin@juszkiewicz.com.pl,
	Fugang Duan <fugang.duan@cixtech.com>
Subject: Re: [PATCH v3 6/6] arm64: dts: cix: add initial CIX P1(SKY1) dts support
In-Reply-To: <Z8WUxyJT1fdHKo67@nchen-desktop>
References: <20250227120619.1741431-1-peter.chen@cixtech.com>
	<20250227120619.1741431-7-peter.chen@cixtech.com>
	<86r03ip0kf.wl-maz@kernel.org>
	<Z8WUxyJT1fdHKo67@nchen-desktop>
User-Agent: Wanderlust/2.15.9 (Almost Unreal) SEMI-EPG/1.14.7 (Harue)
 FLIM-LB/1.14.9 (=?UTF-8?B?R29qxY0=?=) APEL-LB/10.8 EasyPG/1.0.0 Emacs/29.4
 (aarch64-unknown-linux-gnu) MULE/6.0 (HANACHIRUSATO)
Precedence: bulk
X-Mailing-List: linux-kernel@vger.kernel.org
List-Id: <linux-kernel.vger.kernel.org>
List-Subscribe: <mailto:linux-kernel+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-kernel+unsubscribe@vger.kernel.org>
MIME-Version: 1.0 (generated by SEMI-EPG 1.14.7 - "Harue")
Content-Type: text/plain; charset=US-ASCII
X-SA-Exim-Connect-IP: 185.219.108.64
X-SA-Exim-Rcpt-To: peter.chen@cixtech.com, robh@kernel.org, krzk+dt@kernel.org, conor+dt@kernel.org, catalin.marinas@arm.com, will@kernel.org, arnd@arndb.de, linux-arm-kernel@lists.infradead.org, devicetree@vger.kernel.org, linux-kernel@vger.kernel.org, cix-kernel-upstream@cixtech.com, marcin@juszkiewicz.com.pl, fugang.duan@cixtech.com
X-SA-Exim-Mail-From: maz@kernel.org
X-SA-Exim-Scanned: No (on disco-boy.misterjones.org); SAEximRunCond expanded to false

On Mon, 03 Mar 2025 11:38:47 +0000,
Peter Chen <peter.chen@cixtech.com> wrote:
> 
> On 25-02-28 15:10:24, Marc Zyngier wrote:
> 
> Hi Marc,
> 
> Thanks for your detail review.
> 
> > > +
> > > +             cpu10: cpu@a00 {
> > > +                     compatible = "arm,cortex-a720";
> > > +                     enable-method = "psci";
> > > +                     reg = <0x0 0xa00>;
> > > +                     device_type = "cpu";
> > > +                     capacity-dmips-mhz = <1024>;
> > > +             };
> > > +
> > > +             cpu11: cpu@b00 {
> > > +                     compatible = "arm,cortex-a720";
> > > +                     enable-method = "psci";
> > > +                     reg = <0x0 0xb00>;
> > > +                     device_type = "cpu";
> > > +                     capacity-dmips-mhz = <1024>;
> > > +             };
> > 
> > Given that half the A720s are advertised with lower clock speed, how
> > comes they all have the same capacity?
> 
> According to Documentation/devicetree/bindings/cpu/cpu-capacity.txt
> "capacity-dmips-mhz" is u32 value representing CPU capacity expressed
> in normalized DMIPS/MHz, it means CPU capability per MHz. For sky1
> SoC, both middle and big cores are A720, so their capability per MHz
> are the same.

Ah, fair enough. I missed that detail.

> 
> > > +
> > > +     pmu-a520 {
> > > +             compatible = "arm,cortex-a520-pmu";
> > > +             interrupts = <GIC_PPI 7 IRQ_TYPE_LEVEL_LOW>;
> > > +     };
> > > +
> > > +     pmu-a720 {
> > > +             compatible = "arm,cortex-a720-pmu";
> > > +             interrupts = <GIC_PPI 7 IRQ_TYPE_LEVEL_LOW>;
> > > +     };
> > 
> > This is wrong. The default configuration for PPIs is to expose the
> > *same* device on all CPUs. You must use PPI affinities for your PMUs.
> > Please see the GICv3 binding for the details.
> 
> We have discussed internally, we have not seen the benefits routing
> different PPI interrupt to dedicated CPUs. Any use cases?

This isn't about changing the PPI. It is about matching CPUs with
their PMU. Here, you are saying "both PMU types are connected to all
the CPUs using PPI7".

That's obviously not the case.

> I prefer changing pmu nodes as one generic Armv8 PMU node. Is it accepted?

No, that's not acceptable.

> Or must I keep both pmu for A520 and A720, and add PPI affinities to
> describe hardware well?

This is an established practice on all big-little systems: each PMU
node has an affinity that indicates which CPUs they are connected
to. For GICv3+, this is carried by the interrupt specifier.

Please look at existing SoCs supported, such as rk3399, for example.

> 
> > 
> > > +
> > > +     pmu-spe {
> > > +             compatible = "arm,statistical-profiling-extension-v1";
> > > +             interrupts = <GIC_PPI 5 IRQ_TYPE_LEVEL_LOW>;
> > > +     };
> > > +
> > > +     psci {
> > > +             compatible = "arm,psci-1.0";
> > > +             method = "smc";
> > > +     };
> > > +
> > > +     soc@0 {
> > > +             compatible = "simple-bus";
> > > +             ranges = <0 0 0 0 0x20 0>;
> > > +             dma-ranges;
> > > +             #address-cells = <2>;
> > > +             #size-cells = <2>;
> > > +
> > > +             gic: interrupt-controller@e010000 {
> > > +                     compatible = "arm,gic-v3";
> > > +                     reg = <0x0 0x0e010000 0 0x10000>,       /* GICD */
> > > +                           <0x0 0x0e090000 0 0x300000>;       /* GICR * 12 */
> > > +                     interrupts = <GIC_PPI 9 IRQ_TYPE_LEVEL_LOW>;
> > > +                     #interrupt-cells = <3>;
> > 
> > This will need to be bumped up to 4, and all the interrupt specifiers adjusted.
> 
> Depends on if PPI affinities is must.

Definitely a must, unless you want to completely remove all traces of
the PMU, which is of course silly, but a valid alternative.

[...]

> > > +             arm,no-tick-in-suspend;
> > 
> > Why do you need this? Is the HW so broken that you have implemented
> > the global counter in a power domain that isn't always on?
> > 
> 
> Not hardware broken, just arch timer will be powered off at cpu idle
> and system suspend due to power consumption reason.

This is not about the timer. This is about the global counter. If your
counter stops ticking when you're in idle or suspended, your system is
broken and you need this property. If the timer (or more precisely the
comparator) is turned off because the CPU is off, then that's the
expected behaviour and you don't need this property.


-- 
Without deviation from the norm, progress is not possible.

